import{j as e,b as de,u as le,c as N}from"./query-DCZjxv-P.js";import{r as j,k as ue,N as me}from"./vendor-rrO37E5y.js";import{C as A,a as E,b as F,c as T,d as U}from"./card-DYiaF_4c.js";import{P as W,c as g,a as Z,b as he,B as p,S as xe,r as pe,s as je,t as ge,v as ye,w as ve,x as fe,y as u,z as be,A as D}from"./index-CxehogKC.js";import{I}from"./input-BidpwNyN.js";import{B as R}from"./badge-BHc0yM4F.js";import{T as B,a as H,b,c as l,d as Q,e as c}from"./table-hRMm3XCP.js";import{r as Ne,a as Se}from"./formatters-Lk1sxCTq.js";import"./firebase-Cbh-IGzk.js";import"./charts-DxkWeNkm.js";var we="Label",ee=j.forwardRef((t,d)=>e.jsx(W.label,{...t,ref:d,onMouseDown:a=>{a.target.closest("button, input, select, textarea")||(t.onMouseDown?.(a),!a.defaultPrevented&&a.detail>1&&a.preventDefault())}}));ee.displayName=we;var Ce=ee,ke="Separator",K="horizontal",Me=["horizontal","vertical"],se=j.forwardRef((t,d)=>{const{decorative:a,orientation:o=K,...S}=t,y=Ae(o)?o:K,w=a?{role:"none"}:{"aria-orientation":y==="vertical"?y:void 0,role:"separator"};return e.jsx(W.div,{"data-orientation":y,...w,...S,ref:d})});se.displayName=ke;function Ae(t){return Me.includes(t)}var Ee=se;const Fe=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m9 12 2 2 4-4",key:"dzmm74"}]],Te=g("circle-check",Fe);const Ue=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m15 9-6 6",key:"1uzhvr"}],["path",{d:"m9 9 6 6",key:"z0biqf"}]],Pe=g("circle-x",Ue);const $e=[["path",{d:"M12 15V3",key:"m9g1x1"}],["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["path",{d:"m7 10 5 5 5-5",key:"brsn70"}]],X=g("download",$e);const Le=[["path",{d:"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8",key:"v9h5vc"}],["path",{d:"M21 3v5h-5",key:"1q7to0"}],["path",{d:"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16",key:"3uifl3"}],["path",{d:"M8 16H3v5",key:"1cv678"}]],G=g("refresh-cw",Le);const Ye=[["path",{d:"M10 11v6",key:"nco0om"}],["path",{d:"M14 11v6",key:"outv1u"}],["path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6",key:"miytrc"}],["path",{d:"M3 6h18",key:"d0wm0j"}],["path",{d:"M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2",key:"e791ji"}]],_e=g("trash-2",Ye);const De=[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["line",{x1:"19",x2:"19",y1:"8",y2:"14",key:"1bvyxn"}],["line",{x1:"22",x2:"16",y1:"11",y2:"11",key:"1shjgl"}]],Ie=g("user-plus",De);const Re=[["path",{d:"M18 6 6 18",key:"1bl5f8"}],["path",{d:"m6 6 12 12",key:"d8bk6v"}]],Oe=g("x",Re);function J({className:t,...d}){return e.jsx(Ce,{"data-slot":"label",className:Z("flex items-center gap-2 text-sm leading-none font-medium select-none group-data-[disabled=true]:pointer-events-none group-data-[disabled=true]:opacity-50 peer-disabled:cursor-not-allowed peer-disabled:opacity-50",t),...d})}function Ve({className:t,orientation:d="horizontal",decorative:a=!0,...o}){return e.jsx(Ee,{"data-slot":"separator",decorative:a,orientation:d,className:Z("bg-border shrink-0 data-[orientation=horizontal]:h-px data-[orientation=horizontal]:w-full data-[orientation=vertical]:h-full data-[orientation=vertical]:w-px",t),...o})}function Ze(){const{selectedYear:t,isAdmin:d}=ue();if(!d)return e.jsx(me,{to:"/dashboard",replace:!0});const a=de(),[o,S]=j.useState(""),[y,P]=j.useState(!1),[w,$]=j.useState({}),[C,k]=j.useState(null),[L,te]=j.useState(t),{data:ae}=he(t),m=ae?.settings,{data:ne,isLoading:re}=le({queryKey:["allowedUsers"],queryFn:()=>D({action:"list"})}),h=N({mutationFn:ve,onMutate:()=>{k(null)},onSuccess:s=>{const n=s.details?.errors?.length||0,r=s.details?.processed||0,i=n>0?`Sync completed: ${r} records processed with ${n} error(s)`:`Sync completed successfully: ${r} records processed`;k({type:n>0?"error":"success",message:i}),a.invalidateQueries({queryKey:["dashboard"]}),a.invalidateQueries({queryKey:["snapshot"]})},onError:s=>{k({type:"error",message:"Sync failed: "+s.message})}}),O=N({mutationFn:fe,onSuccess:()=>{u.success("Settings updated"),a.invalidateQueries({queryKey:["dashboard"]})},onError:s=>{u.error("Failed to update settings: "+s.message)}}),V=N({mutationFn:s=>D({action:"add",...s}),onSuccess:()=>{u.success("User added"),S(""),P(!1),a.invalidateQueries({queryKey:["allowedUsers"]})},onError:s=>{u.error("Failed to add user: "+s.message)}}),q=N({mutationFn:s=>D({action:"remove",email:s}),onSuccess:()=>{u.success("User removed"),a.invalidateQueries({queryKey:["allowedUsers"]})},onError:s=>{u.error("Failed to remove user: "+s.message)}}),M=N({mutationFn:s=>be({schoolYear:L,dataType:s}),onSuccess:(s,n)=>{const r=new Blob([s.csv],{type:"text/csv"}),i=URL.createObjectURL(r),v=document.createElement("a");v.href=i,v.download=`${L}-${n}.csv`,v.click(),URL.revokeObjectURL(i),u.success("CSV downloaded")},onError:s=>{u.error("CSV export failed: "+s.message)}}),ie=m?[...new Set([...m.activeSchoolYears,"2026-27"])].sort().reverse():[t],ce=s=>{s.preventDefault(),o&&V.mutate({email:o,isAdmin:y})},oe=s=>{const n=w[s];if(!n)return;const r=parseInt(n.students,10),i=parseFloat(n.perStudentCost);if(isNaN(r)||r<0||isNaN(i)||i<0)return;const f={...m?.fundingByYear||{},[s]:{students:r,perStudentCost:i}};O.mutate({fundingByYear:f}),$(Y=>({...Y,[s]:{students:"",perStudentCost:""}}))},z=ne?.users||[];return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold",children:"Admin"}),e.jsx("p",{className:"text-muted-foreground",children:"Manage sync, settings, and users"})]}),e.jsxs(A,{children:[e.jsxs(E,{children:[e.jsx(F,{children:"Data Sync"}),e.jsx(T,{children:"Manually trigger a sync from Airtable to refresh all metrics"})]}),e.jsxs(U,{className:"space-y-4",children:[e.jsxs("div",{className:"flex gap-4",children:[e.jsxs(p,{onClick:()=>h.mutate({}),disabled:h.isPending,children:[e.jsx(G,{className:`mr-2 h-4 w-4 ${h.isPending?"animate-spin":""}`}),h.isPending?"Syncing...":"Sync All Years"]}),e.jsxs(p,{variant:"outline",onClick:()=>h.mutate({schoolYear:t}),disabled:h.isPending,children:["Sync ",t," Only"]})]}),h.isPending&&e.jsxs("div",{className:"flex items-center gap-2 rounded-md border border-border bg-muted/50 p-3",children:[e.jsx(G,{className:"h-4 w-4 animate-spin text-muted-foreground"}),e.jsx("p",{className:"text-sm font-medium",children:"Syncing data from Airtable... This may take a few minutes."})]}),C&&e.jsxs("div",{className:`flex items-start justify-between gap-2 rounded-md border p-3 ${C.type==="success"?"border-success/30 bg-success/10 text-success":"border-destructive/30 bg-destructive/10 text-destructive"}`,children:[e.jsxs("div",{className:"flex items-start gap-2",children:[C.type==="success"?e.jsx(Te,{className:"h-5 w-5 mt-0.5 shrink-0"}):e.jsx(Pe,{className:"h-5 w-5 mt-0.5 shrink-0"}),e.jsx("p",{className:"text-sm font-medium",children:C.message})]}),e.jsx("button",{onClick:()=>k(null),className:"shrink-0 rounded-sm opacity-70 hover:opacity-100",children:e.jsx(Oe,{className:"h-4 w-4"})})]})]})]}),e.jsxs(A,{children:[e.jsxs(E,{children:[e.jsx(F,{children:"Funding Settings"}),e.jsx(T,{children:"Enter the number of students and per-student cost for each year. Total funding is calculated automatically."})]}),e.jsx(U,{children:m&&e.jsx("div",{className:"space-y-4",children:e.jsxs(B,{children:[e.jsx(H,{children:e.jsxs(b,{children:[e.jsx(l,{className:"w-28",children:"Year"}),e.jsx(l,{children:"Students"}),e.jsx(l,{children:"Per-Student Cost"}),e.jsx(l,{className:"text-right",children:"Total Funding"}),e.jsx(l,{className:"w-16"})]})}),e.jsx(Q,{children:m.activeSchoolYears.map(s=>{const n=m.fundingByYear?.[s],r=n!=null&&typeof n=="object"?n:null,i=Ne(n),v=s===m.currentSchoolYear,f=w[s],Y=f?.students||f?.perStudentCost;return e.jsxs(b,{children:[e.jsxs(c,{className:"font-medium",children:[s,v&&e.jsx(R,{variant:"outline",className:"ml-1 text-[10px] py-0",children:"Current"})]}),e.jsx(c,{children:e.jsx(I,{type:"number",placeholder:r?String(r.students):"# students",value:f?.students||"",onChange:_=>$(x=>({...x,[s]:{...x[s],students:_.target.value,perStudentCost:x[s]?.perStudentCost||""}})),className:"w-28"})}),e.jsx(c,{children:e.jsx(I,{type:"number",placeholder:r?String(r.perStudentCost):"$ per student",value:f?.perStudentCost||"",onChange:_=>$(x=>({...x,[s]:{...x[s],perStudentCost:_.target.value,students:x[s]?.students||""}})),className:"w-32"})}),e.jsx(c,{className:"text-right font-semibold text-success",children:i!=null?Se(i):"â€”"}),e.jsx(c,{children:e.jsx(p,{size:"sm",onClick:()=>oe(s),disabled:O.isPending||!Y,children:"Save"})})]},s)})})]})})})]}),e.jsxs(A,{children:[e.jsx(E,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx(F,{children:"Exports"}),e.jsx(T,{children:"Download CSV data for a specific school year"})]}),e.jsxs(xe,{value:L,onValueChange:te,children:[e.jsx(pe,{className:"w-[140px]",children:e.jsx(je,{placeholder:"School Year"})}),e.jsx(ge,{children:ie.map(s=>e.jsx(ye,{value:s,children:s},s))})]})]})}),e.jsx(U,{children:e.jsxs("div",{className:"flex flex-wrap gap-4",children:[e.jsxs(p,{variant:"outline",onClick:()=>M.mutate("enrollment"),disabled:M.isPending,children:[e.jsx(X,{className:"mr-2 h-4 w-4"}),"Enrollment (CSV)"]}),e.jsxs(p,{variant:"outline",onClick:()=>M.mutate("timeline"),disabled:M.isPending,children:[e.jsx(X,{className:"mr-2 h-4 w-4"}),"Timeline (CSV)"]})]})})]}),e.jsx(Ve,{}),e.jsxs(A,{children:[e.jsxs(E,{children:[e.jsx(F,{children:"Allowed Users"}),e.jsx(T,{children:"Manage who can access the dashboard"})]}),e.jsxs(U,{className:"space-y-6",children:[e.jsxs("form",{onSubmit:ce,className:"flex gap-4 items-end",children:[e.jsxs("div",{className:"space-y-2 flex-1",children:[e.jsx(J,{htmlFor:"email",children:"Email Address"}),e.jsx(I,{id:"email",type:"email",placeholder:"user@che.school",value:o,onChange:s=>S(s.target.value)})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",id:"isAdmin",checked:y,onChange:s=>P(s.target.checked)}),e.jsx(J,{htmlFor:"isAdmin",children:"Admin"})]}),e.jsxs(p,{type:"submit",disabled:V.isPending||!o,children:[e.jsx(Ie,{className:"mr-2 h-4 w-4"}),"Add User"]})]}),e.jsxs(B,{children:[e.jsx(H,{children:e.jsxs(b,{children:[e.jsx(l,{children:"Email"}),e.jsx(l,{children:"Role"}),e.jsx(l,{children:"Added"}),e.jsx(l,{className:"w-20"})]})}),e.jsx(Q,{children:re?e.jsx(b,{children:e.jsx(c,{colSpan:4,className:"text-center text-muted-foreground",children:"Loading..."})}):z.length===0?e.jsx(b,{children:e.jsx(c,{colSpan:4,className:"text-center text-muted-foreground",children:"No users configured"})}):z.map(s=>e.jsxs(b,{children:[e.jsx(c,{children:s.email}),e.jsx(c,{children:s.isAdmin?e.jsx(R,{children:"Admin"}):e.jsx(R,{variant:"secondary",children:"Viewer"})}),e.jsx(c,{children:new Date(s.addedAt).toLocaleDateString()}),e.jsx(c,{children:e.jsx(p,{variant:"ghost",size:"icon",onClick:()=>q.mutate(s.email),disabled:q.isPending,children:e.jsx(_e,{className:"h-4 w-4 text-destructive"})})})]},s.email))})]})]})]})]})}export{Ze as AdminPage};
