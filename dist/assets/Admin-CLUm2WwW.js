import{j as e,u as J,b as W,c as m}from"./query-PEscxNU0.js";import{r as h,k as Z}from"./vendor-rrO37E5y.js";import{C as k,a as w,b as S,c as C,d as M}from"./card-DFrA6KgX.js";import{P as q,c,a as H,B as o,t as n}from"./index-D5AKj6n6.js";import{I as L}from"./input-DKvuZJW7.js";import{B as z}from"./badge-C-_tHALX.js";import{T as ee,a as se,b as A,c as P,d as ae,e as u}from"./table-DnmNn9sZ.js";import{t as te,u as re,e as ne,a as ie,m as F}from"./functions-CZAEqjTx.js";import"./firebase-CBGyZlqu.js";import"./charts-mYDaWYVf.js";var oe="Label",B=h.forwardRef((a,r)=>e.jsx(q.label,{...a,ref:r,onMouseDown:t=>{t.target.closest("button, input, select, textarea")||(a.onMouseDown?.(t),!t.defaultPrevented&&t.detail>1&&t.preventDefault())}}));B.displayName=oe;var ce=B,de="Separator",O="horizontal",le=["horizontal","vertical"],Q=h.forwardRef((a,r)=>{const{decorative:t,orientation:i=O,...p}=a,l=me(i)?i:O,j=t?{role:"none"}:{"aria-orientation":l==="vertical"?l:void 0,role:"separator"};return e.jsx(q.div,{"data-orientation":l,...j,...p,ref:r})});Q.displayName=de;function me(a){return le.includes(a)}var ue=Q;const he=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m9 12 2 2 4-4",key:"dzmm74"}]],xe=c("circle-check",he);const pe=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m15 9-6 6",key:"1uzhvr"}],["path",{d:"m9 9 6 6",key:"z0biqf"}]],ye=c("circle-x",pe);const je=[["path",{d:"M12 15V3",key:"m9g1x1"}],["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["path",{d:"m7 10 5 5 5-5",key:"brsn70"}]],I=c("download",je);const ge=[["path",{d:"M6 22a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h8a2.4 2.4 0 0 1 1.704.706l3.588 3.588A2.4 2.4 0 0 1 20 8v12a2 2 0 0 1-2 2z",key:"1oefj6"}],["path",{d:"M14 2v5a1 1 0 0 0 1 1h5",key:"wfsgrz"}],["path",{d:"M10 9H8",key:"b1mrlr"}],["path",{d:"M16 13H8",key:"t4e002"}],["path",{d:"M16 17H8",key:"z1uh3a"}]],ve=c("file-text",ge);const fe=[["path",{d:"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8",key:"v9h5vc"}],["path",{d:"M21 3v5h-5",key:"1q7to0"}],["path",{d:"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16",key:"3uifl3"}],["path",{d:"M8 16H3v5",key:"1cv678"}]],V=c("refresh-cw",fe);const be=[["path",{d:"M10 11v6",key:"nco0om"}],["path",{d:"M14 11v6",key:"outv1u"}],["path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6",key:"miytrc"}],["path",{d:"M3 6h18",key:"d0wm0j"}],["path",{d:"M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2",key:"e791ji"}]],Ne=c("trash-2",be);const ke=[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["line",{x1:"19",x2:"19",y1:"8",y2:"14",key:"1bvyxn"}],["line",{x1:"22",x2:"16",y1:"11",y2:"11",key:"1shjgl"}]],we=c("user-plus",ke);const Se=[["path",{d:"M18 6 6 18",key:"1bl5f8"}],["path",{d:"m6 6 12 12",key:"d8bk6v"}]],Ce=c("x",Se);function $({className:a,...r}){return e.jsx(ce,{"data-slot":"label",className:H("flex items-center gap-2 text-sm leading-none font-medium select-none group-data-[disabled=true]:pointer-events-none group-data-[disabled=true]:opacity-50 peer-disabled:cursor-not-allowed peer-disabled:opacity-50",a),...r})}function Me({className:a,orientation:r="horizontal",decorative:t=!0,...i}){return e.jsx(ue,{"data-slot":"separator",decorative:t,orientation:r,className:H("bg-border shrink-0 data-[orientation=horizontal]:h-px data-[orientation=horizontal]:w-full data-[orientation=vertical]:h-full data-[orientation=vertical]:w-px",a),...i})}function Le(){const{selectedYear:a}=Z(),r=J(),[t,i]=h.useState(""),[p,l]=h.useState(!1),[y,j]=h.useState(""),[g,v]=h.useState(null),{data:K,isLoading:Y}=W({queryKey:["allowedUsers"],queryFn:()=>F({action:"list"})}),d=m({mutationFn:te,onMutate:()=>{v(null)},onSuccess:s=>{const x=s.details?.errors?.length||0,b=s.details?.processed||0,N=x>0?`Sync completed: ${b} records processed with ${x} error(s)`:`Sync completed successfully: ${b} records processed`;v({type:x>0?"error":"success",message:N}),r.invalidateQueries({queryKey:["dashboard"]}),r.invalidateQueries({queryKey:["snapshot"]})},onError:s=>{v({type:"error",message:"Sync failed: "+s.message})}}),T=m({mutationFn:re,onSuccess:()=>{n.success("Settings updated"),j("")},onError:s=>{n.error("Failed to update settings: "+s.message)}}),_=m({mutationFn:s=>F({action:"add",...s}),onSuccess:()=>{n.success("User added"),i(""),l(!1),r.invalidateQueries({queryKey:["allowedUsers"]})},onError:s=>{n.error("Failed to add user: "+s.message)}}),D=m({mutationFn:s=>F({action:"remove",email:s}),onSuccess:()=>{n.success("User removed"),r.invalidateQueries({queryKey:["allowedUsers"]})},onError:s=>{n.error("Failed to remove user: "+s.message)}}),E=m({mutationFn:()=>ne({schoolYear:a,reportType:"annual"}),onSuccess:s=>{window.open(s.url,"_blank"),n.success("PDF generated")},onError:s=>{n.error("PDF export failed: "+s.message)}}),f=m({mutationFn:s=>ie({schoolYear:a,dataType:s}),onSuccess:(s,x)=>{const b=new Blob([s.csv],{type:"text/csv"}),N=URL.createObjectURL(b),U=document.createElement("a");U.href=N,U.download=`${a}-${x}.csv`,U.click(),URL.revokeObjectURL(N),n.success("CSV downloaded")},onError:s=>{n.error("CSV export failed: "+s.message)}}),X=s=>{s.preventDefault(),t&&_.mutate({email:t,isAdmin:p})},G=()=>{const s=parseFloat(y);!isNaN(s)&&s>0&&T.mutate({erbocesPerStudentCost:s})},R=K?.users||[];return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold",children:"Admin"}),e.jsx("p",{className:"text-muted-foreground",children:"Manage sync, settings, and users"})]}),e.jsxs(k,{children:[e.jsxs(w,{children:[e.jsx(S,{children:"Data Sync"}),e.jsx(C,{children:"Manually trigger a sync from Airtable to refresh all metrics"})]}),e.jsxs(M,{className:"space-y-4",children:[e.jsxs("div",{className:"flex gap-4",children:[e.jsxs(o,{onClick:()=>d.mutate({}),disabled:d.isPending,children:[e.jsx(V,{className:`mr-2 h-4 w-4 ${d.isPending?"animate-spin":""}`}),d.isPending?"Syncing...":"Sync All Years"]}),e.jsxs(o,{variant:"outline",onClick:()=>d.mutate({schoolYear:a}),disabled:d.isPending,children:["Sync ",a," Only"]})]}),d.isPending&&e.jsxs("div",{className:"flex items-center gap-2 rounded-md border border-border bg-muted/50 p-3",children:[e.jsx(V,{className:"h-4 w-4 animate-spin text-muted-foreground"}),e.jsx("p",{className:"text-sm font-medium",children:"Syncing data from Airtable... This may take a few minutes."})]}),g&&e.jsxs("div",{className:`flex items-start justify-between gap-2 rounded-md border p-3 ${g.type==="success"?"border-success/30 bg-success/10 text-success":"border-destructive/30 bg-destructive/10 text-destructive"}`,children:[e.jsxs("div",{className:"flex items-start gap-2",children:[g.type==="success"?e.jsx(xe,{className:"h-5 w-5 mt-0.5 shrink-0"}):e.jsx(ye,{className:"h-5 w-5 mt-0.5 shrink-0"}),e.jsx("p",{className:"text-sm font-medium",children:g.message})]}),e.jsx("button",{onClick:()=>v(null),className:"shrink-0 rounded-sm opacity-70 hover:opacity-100",children:e.jsx(Ce,{className:"h-4 w-4"})})]})]})]}),e.jsxs(k,{children:[e.jsxs(w,{children:[e.jsx(S,{children:"ERBOCES Settings"}),e.jsx(C,{children:"Configure the per-student cost for revenue projections"})]}),e.jsx(M,{children:e.jsxs("div",{className:"flex gap-4 items-end",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx($,{htmlFor:"erboces",children:"Per-Student Cost ($)"}),e.jsx(L,{id:"erboces",type:"number",placeholder:"11380",value:y,onChange:s=>j(s.target.value),className:"w-40"})]}),e.jsx(o,{onClick:G,disabled:T.isPending||!y,children:"Update"})]})})]}),e.jsxs(k,{children:[e.jsxs(w,{children:[e.jsx(S,{children:"Exports"}),e.jsxs(C,{children:["Download reports and data for ",a]})]}),e.jsx(M,{children:e.jsxs("div",{className:"flex flex-wrap gap-4",children:[e.jsxs(o,{variant:"outline",onClick:()=>E.mutate(),disabled:E.isPending,children:[e.jsx(ve,{className:"mr-2 h-4 w-4"}),E.isPending?"Generating...":"Annual Report (PDF)"]}),e.jsxs(o,{variant:"outline",onClick:()=>f.mutate("enrollment"),disabled:f.isPending,children:[e.jsx(I,{className:"mr-2 h-4 w-4"}),"Enrollment (CSV)"]}),e.jsxs(o,{variant:"outline",onClick:()=>f.mutate("timeline"),disabled:f.isPending,children:[e.jsx(I,{className:"mr-2 h-4 w-4"}),"Timeline (CSV)"]})]})})]}),e.jsx(Me,{}),e.jsxs(k,{children:[e.jsxs(w,{children:[e.jsx(S,{children:"Allowed Users"}),e.jsx(C,{children:"Manage who can access the dashboard"})]}),e.jsxs(M,{className:"space-y-6",children:[e.jsxs("form",{onSubmit:X,className:"flex gap-4 items-end",children:[e.jsxs("div",{className:"space-y-2 flex-1",children:[e.jsx($,{htmlFor:"email",children:"Email Address"}),e.jsx(L,{id:"email",type:"email",placeholder:"user@che.school",value:t,onChange:s=>i(s.target.value)})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",id:"isAdmin",checked:p,onChange:s=>l(s.target.checked)}),e.jsx($,{htmlFor:"isAdmin",children:"Admin"})]}),e.jsxs(o,{type:"submit",disabled:_.isPending||!t,children:[e.jsx(we,{className:"mr-2 h-4 w-4"}),"Add User"]})]}),e.jsxs(ee,{children:[e.jsx(se,{children:e.jsxs(A,{children:[e.jsx(P,{children:"Email"}),e.jsx(P,{children:"Role"}),e.jsx(P,{children:"Added"}),e.jsx(P,{className:"w-20"})]})}),e.jsx(ae,{children:Y?e.jsx(A,{children:e.jsx(u,{colSpan:4,className:"text-center text-muted-foreground",children:"Loading..."})}):R.length===0?e.jsx(A,{children:e.jsx(u,{colSpan:4,className:"text-center text-muted-foreground",children:"No users configured"})}):R.map(s=>e.jsxs(A,{children:[e.jsx(u,{children:s.email}),e.jsx(u,{children:s.isAdmin?e.jsx(z,{children:"Admin"}):e.jsx(z,{variant:"secondary",children:"Viewer"})}),e.jsx(u,{children:new Date(s.addedAt).toLocaleDateString()}),e.jsx(u,{children:e.jsx(o,{variant:"ghost",size:"icon",onClick:()=>D.mutate(s.email),disabled:D.isPending,children:e.jsx(Ne,{className:"h-4 w-4 text-destructive"})})})]},s.email))})]})]})]})]})}export{Le as AdminPage};
