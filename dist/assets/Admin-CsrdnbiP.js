import{j as e,u as le,b as ue,c as f}from"./query-PEscxNU0.js";import{r as u,k as me}from"./vendor-rrO37E5y.js";import{C as y,a as N,b,c as S,d as k}from"./card-CvKyquMr.js";import{P as J,c as m,a as W,B as d,t as o}from"./index-Rivh-WXP.js";import{I as $}from"./input-plEALA3f.js";import{B as L}from"./badge-CDLwJsqM.js";import{T as xe,a as he,b as D,c as I,d as pe,e as v}from"./table-B2I4_9IN.js";import{u as je,a as w,b as ge,t as fe,j as ve,k as ye,l as Ne,m as O}from"./useDashboardData--dUiMfac.js";import"./firebase-Cbh-IGzk.js";import"./charts-DxkWeNkm.js";var be="Label",Z=u.forwardRef((t,i)=>e.jsx(J.label,{...t,ref:i,onMouseDown:r=>{r.target.closest("button, input, select, textarea")||(t.onMouseDown?.(r),!r.defaultPrevented&&r.detail>1&&r.preventDefault())}}));Z.displayName=be;var Se=Z,ke="Separator",Q="horizontal",we=["horizontal","vertical"],ee=u.forwardRef((t,i)=>{const{decorative:r,orientation:l=Q,...C}=t,j=Ce(l)?l:Q,M=r?{role:"none"}:{"aria-orientation":j==="vertical"?j:void 0,role:"separator"};return e.jsx(J.div,{"data-orientation":j,...M,...C,ref:i})});ee.displayName=ke;function Ce(t){return we.includes(t)}var Pe=ee;const Me=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m9 12 2 2 4-4",key:"dzmm74"}]],Fe=m("circle-check",Me);const Ae=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m15 9-6 6",key:"1uzhvr"}],["path",{d:"m9 9 6 6",key:"z0biqf"}]],Ee=m("circle-x",Ae);const Ue=[["path",{d:"M12 15V3",key:"m9g1x1"}],["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["path",{d:"m7 10 5 5 5-5",key:"brsn70"}]],K=m("download",Ue);const Te=[["path",{d:"M6 22a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h8a2.4 2.4 0 0 1 1.704.706l3.588 3.588A2.4 2.4 0 0 1 20 8v12a2 2 0 0 1-2 2z",key:"1oefj6"}],["path",{d:"M14 2v5a1 1 0 0 0 1 1h5",key:"wfsgrz"}],["path",{d:"M10 9H8",key:"b1mrlr"}],["path",{d:"M16 13H8",key:"t4e002"}],["path",{d:"M16 17H8",key:"z1uh3a"}]],$e=m("file-text",Te);const De=[["path",{d:"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8",key:"v9h5vc"}],["path",{d:"M21 3v5h-5",key:"1q7to0"}],["path",{d:"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16",key:"3uifl3"}],["path",{d:"M8 16H3v5",key:"1cv678"}]],X=m("refresh-cw",De);const Ie=[["path",{d:"M10 11v6",key:"nco0om"}],["path",{d:"M14 11v6",key:"outv1u"}],["path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6",key:"miytrc"}],["path",{d:"M3 6h18",key:"d0wm0j"}],["path",{d:"M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2",key:"e791ji"}]],_e=m("trash-2",Ie);const Ye=[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["line",{x1:"19",x2:"19",y1:"8",y2:"14",key:"1bvyxn"}],["line",{x1:"22",x2:"16",y1:"11",y2:"11",key:"1shjgl"}]],Le=m("user-plus",Ye);const Oe=[["path",{d:"M18 6 6 18",key:"1bl5f8"}],["path",{d:"m6 6 12 12",key:"d8bk6v"}]],Re=m("x",Oe);function R({className:t,...i}){return e.jsx(Se,{"data-slot":"label",className:W("flex items-center gap-2 text-sm leading-none font-medium select-none group-data-[disabled=true]:pointer-events-none group-data-[disabled=true]:opacity-50 peer-disabled:cursor-not-allowed peer-disabled:opacity-50",t),...i})}function G({className:t,orientation:i="horizontal",decorative:r=!0,...l}){return e.jsx(Pe,{"data-slot":"separator",decorative:r,orientation:i,className:W("bg-border shrink-0 data-[orientation=horizontal]:h-px data-[orientation=horizontal]:w-full data-[orientation=vertical]:h-full data-[orientation=vertical]:w-px",t),...l})}function We(){const{selectedYear:t}=me(),i=le(),[r,l]=u.useState(""),[C,j]=u.useState(!1),[P,M]=u.useState(""),[F,z]=u.useState({}),[A,V]=u.useState(""),[E,U]=u.useState(null),{data:se}=je(t),a=se?.settings,{data:te,isLoading:ae}=ue({queryKey:["allowedUsers"],queryFn:()=>O({action:"list"})}),x=f({mutationFn:fe,onMutate:()=>{U(null)},onSuccess:s=>{const n=s.details?.errors?.length||0,c=s.details?.processed||0,h=n>0?`Sync completed: ${c} records processed with ${n} error(s)`:`Sync completed successfully: ${c} records processed`;U({type:n>0?"error":"success",message:h}),i.invalidateQueries({queryKey:["dashboard"]}),i.invalidateQueries({queryKey:["snapshot"]})},onError:s=>{U({type:"error",message:"Sync failed: "+s.message})}}),g=f({mutationFn:ve,onSuccess:()=>{o.success("Settings updated"),M("")},onError:s=>{o.error("Failed to update settings: "+s.message)}}),q=f({mutationFn:s=>O({action:"add",...s}),onSuccess:()=>{o.success("User added"),l(""),j(!1),i.invalidateQueries({queryKey:["allowedUsers"]})},onError:s=>{o.error("Failed to add user: "+s.message)}}),H=f({mutationFn:s=>O({action:"remove",email:s}),onSuccess:()=>{o.success("User removed"),i.invalidateQueries({queryKey:["allowedUsers"]})},onError:s=>{o.error("Failed to remove user: "+s.message)}}),_=f({mutationFn:()=>ye({schoolYear:t,reportType:"annual"}),onSuccess:s=>{window.open(s.url,"_blank"),o.success("PDF generated")},onError:s=>{o.error("PDF export failed: "+s.message)}}),T=f({mutationFn:s=>Ne({schoolYear:t,dataType:s}),onSuccess:(s,n)=>{const c=new Blob([s.csv],{type:"text/csv"}),h=URL.createObjectURL(c),p=document.createElement("a");p.href=h,p.download=`${t}-${n}.csv`,p.click(),URL.revokeObjectURL(h),o.success("CSV downloaded")},onError:s=>{o.error("CSV export failed: "+s.message)}}),ne=s=>{s.preventDefault(),r&&q.mutate({email:r,isAdmin:C})},re=()=>{const s=parseFloat(P);!isNaN(s)&&s>0&&g.mutate({erbocesPerStudentCost:s})},ie=()=>{const s=parseInt(A,10);!isNaN(s)&&s>0&&(g.mutate({projectedStudents:s}),V(""))},ce=s=>{const n=F[s];if(!n)return;const c=parseFloat(n);if(isNaN(c)||c<0)return;const p={...a?.fundingByYear||{},[s]:c};g.mutate({fundingByYear:p}),z(Y=>({...Y,[s]:""}))},B=te?.users||[];return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold",children:"Admin"}),e.jsx("p",{className:"text-muted-foreground",children:"Manage sync, settings, and users"})]}),e.jsxs(y,{children:[e.jsxs(N,{children:[e.jsx(b,{children:"Data Sync"}),e.jsx(S,{children:"Manually trigger a sync from Airtable to refresh all metrics"})]}),e.jsxs(k,{className:"space-y-4",children:[e.jsxs("div",{className:"flex gap-4",children:[e.jsxs(d,{onClick:()=>x.mutate({}),disabled:x.isPending,children:[e.jsx(X,{className:`mr-2 h-4 w-4 ${x.isPending?"animate-spin":""}`}),x.isPending?"Syncing...":"Sync All Years"]}),e.jsxs(d,{variant:"outline",onClick:()=>x.mutate({schoolYear:t}),disabled:x.isPending,children:["Sync ",t," Only"]})]}),x.isPending&&e.jsxs("div",{className:"flex items-center gap-2 rounded-md border border-border bg-muted/50 p-3",children:[e.jsx(X,{className:"h-4 w-4 animate-spin text-muted-foreground"}),e.jsx("p",{className:"text-sm font-medium",children:"Syncing data from Airtable... This may take a few minutes."})]}),E&&e.jsxs("div",{className:`flex items-start justify-between gap-2 rounded-md border p-3 ${E.type==="success"?"border-success/30 bg-success/10 text-success":"border-destructive/30 bg-destructive/10 text-destructive"}`,children:[e.jsxs("div",{className:"flex items-start gap-2",children:[E.type==="success"?e.jsx(Fe,{className:"h-5 w-5 mt-0.5 shrink-0"}):e.jsx(Ee,{className:"h-5 w-5 mt-0.5 shrink-0"}),e.jsx("p",{className:"text-sm font-medium",children:E.message})]}),e.jsx("button",{onClick:()=>U(null),className:"shrink-0 rounded-sm opacity-70 hover:opacity-100",children:e.jsx(Re,{className:"h-4 w-4"})})]})]})]}),e.jsxs(y,{children:[e.jsxs(N,{children:[e.jsx(b,{children:"Funding Settings"}),e.jsx(S,{children:"Configure per-student cost for projections and record actual total funding per year"})]}),e.jsxs(k,{className:"space-y-6",children:[e.jsxs("div",{className:"flex gap-4 items-end",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(R,{htmlFor:"erboces",children:"Per-Student Cost ($)"}),e.jsx($,{id:"erboces",type:"number",placeholder:"11380",value:P,onChange:s=>M(s.target.value),className:"w-40"})]}),e.jsx(d,{onClick:re,disabled:g.isPending||!P,children:"Update"})]}),a&&e.jsxs(e.Fragment,{children:[e.jsx(G,{}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-semibold",children:"Total Funding by Year"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Enter actual total funding for past years. Current/future years use per-student cost × enrollment as a projection."})]}),e.jsx("div",{className:"space-y-3",children:a.activeSchoolYears.map(s=>{const n=a.fundingByYear?.[s],c=s===a.currentSchoolYear,h=a.activeSchoolYears.indexOf(s),p=a.activeSchoolYears.indexOf(a.currentSchoolYear),Y=h<p;return e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"w-20 shrink-0",children:[e.jsx("span",{className:"text-sm font-medium",children:s}),c&&e.jsx(L,{variant:"outline",className:"ml-1 text-[10px] py-0",children:"Current"})]}),Y?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex gap-2 items-end flex-1",children:[e.jsx($,{type:"number",placeholder:n?w(n):"Enter total funding",value:F[s]||"",onChange:de=>z(oe=>({...oe,[s]:de.target.value})),className:"w-48"}),e.jsx(d,{size:"sm",onClick:()=>ce(s),disabled:g.isPending||!F[s],children:"Save"})]}),n!=null&&!F[s]&&e.jsx("span",{className:"text-sm text-success font-medium",children:w(n)})]}):e.jsxs("span",{className:"text-sm text-muted-foreground",children:["Projected from enrollment × per-student cost",n!=null&&e.jsxs("span",{className:"ml-2 text-foreground font-medium",children:["(Override: ",w(n),")"]})]})]},s)})})]})]})]})]}),a&&e.jsxs(y,{children:[e.jsxs(N,{children:[e.jsxs(b,{children:["Estimated Funding — ",a.currentSchoolYear]}),e.jsx(S,{children:"Projected funding based on per-student cost × projected students"})]}),e.jsx(k,{className:"space-y-4",children:e.jsxs("div",{className:"grid gap-4 sm:grid-cols-3",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Per-Student Cost"}),e.jsx("p",{className:"text-xl font-semibold",children:w(a.erbocesPerStudentCost)})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Projected Students"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx($,{type:"number",placeholder:a.projectedStudents?String(a.projectedStudents):"Enter count",value:A,onChange:s=>V(s.target.value),className:"w-32"}),e.jsx(d,{size:"sm",onClick:ie,disabled:g.isPending||!A,children:"Save"}),a.projectedStudents!=null&&!A&&e.jsx("span",{className:"text-xl font-semibold",children:ge(a.projectedStudents)})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Estimated Total Funding"}),e.jsx("p",{className:"text-xl font-semibold text-success",children:a.projectedStudents?w(a.erbocesPerStudentCost*a.projectedStudents):"—"})]})]})})]}),e.jsxs(y,{children:[e.jsxs(N,{children:[e.jsx(b,{children:"Exports"}),e.jsxs(S,{children:["Download reports and data for ",t]})]}),e.jsx(k,{children:e.jsxs("div",{className:"flex flex-wrap gap-4",children:[e.jsxs(d,{variant:"outline",onClick:()=>_.mutate(),disabled:_.isPending,children:[e.jsx($e,{className:"mr-2 h-4 w-4"}),_.isPending?"Generating...":"Annual Report (PDF)"]}),e.jsxs(d,{variant:"outline",onClick:()=>T.mutate("enrollment"),disabled:T.isPending,children:[e.jsx(K,{className:"mr-2 h-4 w-4"}),"Enrollment (CSV)"]}),e.jsxs(d,{variant:"outline",onClick:()=>T.mutate("timeline"),disabled:T.isPending,children:[e.jsx(K,{className:"mr-2 h-4 w-4"}),"Timeline (CSV)"]})]})})]}),e.jsx(G,{}),e.jsxs(y,{children:[e.jsxs(N,{children:[e.jsx(b,{children:"Allowed Users"}),e.jsx(S,{children:"Manage who can access the dashboard"})]}),e.jsxs(k,{className:"space-y-6",children:[e.jsxs("form",{onSubmit:ne,className:"flex gap-4 items-end",children:[e.jsxs("div",{className:"space-y-2 flex-1",children:[e.jsx(R,{htmlFor:"email",children:"Email Address"}),e.jsx($,{id:"email",type:"email",placeholder:"user@che.school",value:r,onChange:s=>l(s.target.value)})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",id:"isAdmin",checked:C,onChange:s=>j(s.target.checked)}),e.jsx(R,{htmlFor:"isAdmin",children:"Admin"})]}),e.jsxs(d,{type:"submit",disabled:q.isPending||!r,children:[e.jsx(Le,{className:"mr-2 h-4 w-4"}),"Add User"]})]}),e.jsxs(xe,{children:[e.jsx(he,{children:e.jsxs(D,{children:[e.jsx(I,{children:"Email"}),e.jsx(I,{children:"Role"}),e.jsx(I,{children:"Added"}),e.jsx(I,{className:"w-20"})]})}),e.jsx(pe,{children:ae?e.jsx(D,{children:e.jsx(v,{colSpan:4,className:"text-center text-muted-foreground",children:"Loading..."})}):B.length===0?e.jsx(D,{children:e.jsx(v,{colSpan:4,className:"text-center text-muted-foreground",children:"No users configured"})}):B.map(s=>e.jsxs(D,{children:[e.jsx(v,{children:s.email}),e.jsx(v,{children:s.isAdmin?e.jsx(L,{children:"Admin"}):e.jsx(L,{variant:"secondary",children:"Viewer"})}),e.jsx(v,{children:new Date(s.addedAt).toLocaleDateString()}),e.jsx(v,{children:e.jsx(d,{variant:"ghost",size:"icon",onClick:()=>H.mutate(s.email),disabled:H.isPending,children:e.jsx(_e,{className:"h-4 w-4 text-destructive"})})})]},s.email))})]})]})]})]})}export{We as AdminPage};
