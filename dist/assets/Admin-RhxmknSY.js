import{j as e,b as he,u as me,c as N}from"./query-DCZjxv-P.js";import{r as g,k as xe,N as pe}from"./vendor-rrO37E5y.js";import{C as b,a as w,b as C,c as k,d as M}from"./card-qxupwtp7.js";import{P as ee,c as f,a as se,b as je,B as x,S as ge,r as ve,s as ye,t as fe,v as Se,w as Ne,x as be,y as p,z as we,A as V}from"./index-BLRpuqN8.js";import{I as P}from"./input-B87U45rj.js";import{B as $}from"./badge-Ci3l8aCq.js";import{T as O,a as z,b as j,c as o,d as B,e as c}from"./table-C5koZFNW.js";import{r as Ce,a as ke}from"./formatters-Lk1sxCTq.js";import"./firebase-Cbh-IGzk.js";import"./charts-DxkWeNkm.js";var Me="Label",te=g.forwardRef((a,h)=>e.jsx(ee.label,{...a,ref:h,onMouseDown:r=>{r.target.closest("button, input, select, textarea")||(a.onMouseDown?.(r),!r.defaultPrevented&&r.detail>1&&r.preventDefault())}}));te.displayName=Me;var Ae=te,Ee="Separator",G="horizontal",Te=["horizontal","vertical"],ne=g.forwardRef((a,h)=>{const{decorative:r,orientation:d=G,...A}=a,S=Fe(d)?d:G,E=r?{role:"none"}:{"aria-orientation":S==="vertical"?S:void 0,role:"separator"};return e.jsx(ee.div,{"data-orientation":S,...E,...A,ref:h})});ne.displayName=Ee;function Fe(a){return Te.includes(a)}var Ue=ne;const Ye=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m9 12 2 2 4-4",key:"dzmm74"}]],Pe=f("circle-check",Ye);const $e=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m15 9-6 6",key:"1uzhvr"}],["path",{d:"m9 9 6 6",key:"z0biqf"}]],Ie=f("circle-x",$e);const Le=[["path",{d:"M12 15V3",key:"m9g1x1"}],["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["path",{d:"m7 10 5 5 5-5",key:"brsn70"}]],J=f("download",Le);const _e=[["path",{d:"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8",key:"v9h5vc"}],["path",{d:"M21 3v5h-5",key:"1q7to0"}],["path",{d:"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16",key:"3uifl3"}],["path",{d:"M8 16H3v5",key:"1cv678"}]],W=f("refresh-cw",_e);const De=[["path",{d:"M10 11v6",key:"nco0om"}],["path",{d:"M14 11v6",key:"outv1u"}],["path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6",key:"miytrc"}],["path",{d:"M3 6h18",key:"d0wm0j"}],["path",{d:"M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2",key:"e791ji"}]],Re=f("trash-2",De);const Ve=[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["line",{x1:"19",x2:"19",y1:"8",y2:"14",key:"1bvyxn"}],["line",{x1:"22",x2:"16",y1:"11",y2:"11",key:"1shjgl"}]],Oe=f("user-plus",Ve);const ze=[["path",{d:"M18 6 6 18",key:"1bl5f8"}],["path",{d:"m6 6 12 12",key:"d8bk6v"}]],Be=f("x",ze);function Z({className:a,...h}){return e.jsx(Ae,{"data-slot":"label",className:se("flex items-center gap-2 text-sm leading-none font-medium select-none group-data-[disabled=true]:pointer-events-none group-data-[disabled=true]:opacity-50 peer-disabled:cursor-not-allowed peer-disabled:opacity-50",a),...h})}function qe({className:a,orientation:h="horizontal",decorative:r=!0,...d}){return e.jsx(Ue,{"data-slot":"separator",decorative:r,orientation:h,className:se("bg-border shrink-0 data-[orientation=horizontal]:h-px data-[orientation=horizontal]:w-full data-[orientation=vertical]:h-full data-[orientation=vertical]:w-px",a),...d})}function ts(){const{selectedYear:a,isAdmin:h}=xe();if(!h)return e.jsx(pe,{to:"/dashboard",replace:!0});const r=he(),[d,A]=g.useState(""),[S,I]=g.useState(!1),[E,L]=g.useState({}),[q,H]=g.useState({}),[T,F]=g.useState(null),[_,ae]=g.useState(a),{data:re}=je(a),l=re?.settings,{data:ie,isLoading:ce}=me({queryKey:["allowedUsers"],queryFn:()=>V({action:"list"})}),v=N({mutationFn:Ne,onMutate:()=>{F(null)},onSuccess:s=>{const t=s.details?.errors?.length||0,n=s.details?.processed||0,i=t>0?`Sync completed: ${n} records processed with ${t} error(s)`:`Sync completed successfully: ${n} records processed`;F({type:t>0?"error":"success",message:i}),r.invalidateQueries({queryKey:["dashboard"]}),r.invalidateQueries({queryKey:["snapshot"]})},onError:s=>{F({type:"error",message:"Sync failed: "+s.message})}}),U=N({mutationFn:be,onSuccess:()=>{p.success("Settings updated"),r.invalidateQueries({queryKey:["dashboard"]})},onError:s=>{p.error("Failed to update settings: "+s.message)}}),Q=N({mutationFn:s=>V({action:"add",...s}),onSuccess:()=>{p.success("User added"),A(""),I(!1),r.invalidateQueries({queryKey:["allowedUsers"]})},onError:s=>{p.error("Failed to add user: "+s.message)}}),K=N({mutationFn:s=>V({action:"remove",email:s}),onSuccess:()=>{p.success("User removed"),r.invalidateQueries({queryKey:["allowedUsers"]})},onError:s=>{p.error("Failed to remove user: "+s.message)}}),Y=N({mutationFn:s=>we({schoolYear:_,dataType:s}),onSuccess:(s,t)=>{const n=new Blob([s.csv],{type:"text/csv"}),i=URL.createObjectURL(n),u=document.createElement("a");u.href=i,u.download=`${_}-${t}.csv`,u.click(),URL.revokeObjectURL(i),p.success("CSV downloaded")},onError:s=>{p.error("CSV export failed: "+s.message)}}),oe=l?[...new Set([...l.activeSchoolYears,"2026-27"])].sort().reverse():[a],le=s=>{s.preventDefault(),d&&Q.mutate({email:d,isAdmin:S})},de=s=>{const t=E[s];if(!t)return;const n=parseInt(t.students,10),i=parseFloat(t.perStudentCost);if(isNaN(n)||n<0||isNaN(i)||i<0)return;const m={...l?.fundingByYear||{},[s]:{students:n,perStudentCost:i}};U.mutate({fundingByYear:m}),L(D=>({...D,[s]:{students:"",perStudentCost:""}}))},ue=s=>{const t=q[s];if(!t)return;const n=parseInt(t,10);if(isNaN(n)||n<0)return;const i=l?.nonStartersByYear||{};U.mutate({nonStartersByYear:{...i,[s]:n}}),H(u=>({...u,[s]:""}))},X=ie?.users||[];return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold",children:"Admin"}),e.jsx("p",{className:"text-muted-foreground",children:"Manage sync, settings, and users"})]}),e.jsxs(b,{children:[e.jsxs(w,{children:[e.jsx(C,{children:"Data Sync"}),e.jsx(k,{children:"Manually trigger a sync from Airtable to refresh all metrics"})]}),e.jsxs(M,{className:"space-y-4",children:[e.jsxs("div",{className:"flex gap-4",children:[e.jsxs(x,{onClick:()=>v.mutate({}),disabled:v.isPending,children:[e.jsx(W,{className:`mr-2 h-4 w-4 ${v.isPending?"animate-spin":""}`}),v.isPending?"Syncing...":"Sync All Years"]}),e.jsxs(x,{variant:"outline",onClick:()=>v.mutate({schoolYear:a}),disabled:v.isPending,children:["Sync ",a," Only"]})]}),v.isPending&&e.jsxs("div",{className:"flex items-center gap-2 rounded-md border border-border bg-muted/50 p-3",children:[e.jsx(W,{className:"h-4 w-4 animate-spin text-muted-foreground"}),e.jsx("p",{className:"text-sm font-medium",children:"Syncing data from Airtable... This may take a few minutes."})]}),T&&e.jsxs("div",{className:`flex items-start justify-between gap-2 rounded-md border p-3 ${T.type==="success"?"border-success/30 bg-success/10 text-success":"border-destructive/30 bg-destructive/10 text-destructive"}`,children:[e.jsxs("div",{className:"flex items-start gap-2",children:[T.type==="success"?e.jsx(Pe,{className:"h-5 w-5 mt-0.5 shrink-0"}):e.jsx(Ie,{className:"h-5 w-5 mt-0.5 shrink-0"}),e.jsx("p",{className:"text-sm font-medium",children:T.message})]}),e.jsx("button",{onClick:()=>F(null),className:"shrink-0 rounded-sm opacity-70 hover:opacity-100",children:e.jsx(Be,{className:"h-4 w-4"})})]})]})]}),e.jsxs(b,{children:[e.jsxs(w,{children:[e.jsx(C,{children:"Funding Settings"}),e.jsx(k,{children:"Enter the number of students and per-student cost for each year. Total funding is calculated automatically."})]}),e.jsx(M,{children:l&&e.jsx("div",{className:"space-y-4",children:e.jsxs(O,{children:[e.jsx(z,{children:e.jsxs(j,{children:[e.jsx(o,{className:"w-28",children:"Year"}),e.jsx(o,{children:"Students"}),e.jsx(o,{children:"Per-Student Cost"}),e.jsx(o,{className:"text-right",children:"Total Funding"}),e.jsx(o,{className:"w-16"})]})}),e.jsx(B,{children:l.activeSchoolYears.map(s=>{const t=l.fundingByYear?.[s],n=t!=null&&typeof t=="object"?t:null,i=Ce(t),u=s===l.currentSchoolYear,m=E[s],D=m?.students||m?.perStudentCost;return e.jsxs(j,{children:[e.jsxs(c,{className:"font-medium",children:[s,u&&e.jsx($,{variant:"outline",className:"ml-1 text-[10px] py-0",children:"Current"})]}),e.jsx(c,{children:e.jsx(P,{type:"number",placeholder:n?String(n.students):"# students",value:m?.students||"",onChange:R=>L(y=>({...y,[s]:{...y[s],students:R.target.value,perStudentCost:y[s]?.perStudentCost||""}})),className:"w-28"})}),e.jsx(c,{children:e.jsx(P,{type:"number",placeholder:n?String(n.perStudentCost):"$ per student",value:m?.perStudentCost||"",onChange:R=>L(y=>({...y,[s]:{...y[s],perStudentCost:R.target.value,students:y[s]?.students||""}})),className:"w-32"})}),e.jsx(c,{className:"text-right font-semibold text-success",children:i!=null?ke(i):"—"}),e.jsx(c,{children:e.jsx(x,{size:"sm",onClick:()=>de(s),disabled:U.isPending||!D,children:"Save"})})]},s)})})]})})})]}),e.jsxs(b,{children:[e.jsxs(w,{children:[e.jsx(C,{children:"Manual Enrollment Metrics"}),e.jsx(k,{children:"Manually set non-starters count per year. These override the calculated values on the dashboard."})]}),e.jsx(M,{children:l&&e.jsxs(O,{children:[e.jsx(z,{children:e.jsxs(j,{children:[e.jsx(o,{className:"w-28",children:"Year"}),e.jsx(o,{children:"Non-Starters"}),e.jsx(o,{className:"text-right",children:"Current Value"}),e.jsx(o,{className:"w-16"})]})}),e.jsx(B,{children:l.activeSchoolYears.map(s=>{const t=l.nonStartersByYear?.[s],n=q[s],i=s===l.currentSchoolYear;return e.jsxs(j,{children:[e.jsxs(c,{className:"font-medium",children:[s,i&&e.jsx($,{variant:"outline",className:"ml-1 text-[10px] py-0",children:"Current"})]}),e.jsx(c,{children:e.jsx(P,{type:"number",placeholder:t!=null?String(t):"# non-starters",value:n||"",onChange:u=>H(m=>({...m,[s]:u.target.value})),className:"w-36"})}),e.jsx(c,{className:"text-right font-semibold",children:t!=null?t.toLocaleString():"—"}),e.jsx(c,{children:e.jsx(x,{size:"sm",onClick:()=>ue(s),disabled:U.isPending||!n,children:"Save"})})]},s)})})]})})]}),e.jsxs(b,{children:[e.jsx(w,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx(C,{children:"Exports"}),e.jsx(k,{children:"Download CSV data for a specific school year"})]}),e.jsxs(ge,{value:_,onValueChange:ae,children:[e.jsx(ve,{className:"w-[140px]",children:e.jsx(ye,{placeholder:"School Year"})}),e.jsx(fe,{children:oe.map(s=>e.jsx(Se,{value:s,children:s},s))})]})]})}),e.jsx(M,{children:e.jsxs("div",{className:"flex flex-wrap gap-4",children:[e.jsxs(x,{variant:"outline",onClick:()=>Y.mutate("enrollment"),disabled:Y.isPending,children:[e.jsx(J,{className:"mr-2 h-4 w-4"}),"Enrollment (CSV)"]}),e.jsxs(x,{variant:"outline",onClick:()=>Y.mutate("timeline"),disabled:Y.isPending,children:[e.jsx(J,{className:"mr-2 h-4 w-4"}),"Timeline (CSV)"]})]})})]}),e.jsx(qe,{}),e.jsxs(b,{children:[e.jsxs(w,{children:[e.jsx(C,{children:"Allowed Users"}),e.jsx(k,{children:"Manage who can access the dashboard"})]}),e.jsxs(M,{className:"space-y-6",children:[e.jsxs("form",{onSubmit:le,className:"flex gap-4 items-end",children:[e.jsxs("div",{className:"space-y-2 flex-1",children:[e.jsx(Z,{htmlFor:"email",children:"Email Address"}),e.jsx(P,{id:"email",type:"email",placeholder:"user@che.school",value:d,onChange:s=>A(s.target.value)})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",id:"isAdmin",checked:S,onChange:s=>I(s.target.checked)}),e.jsx(Z,{htmlFor:"isAdmin",children:"Admin"})]}),e.jsxs(x,{type:"submit",disabled:Q.isPending||!d,children:[e.jsx(Oe,{className:"mr-2 h-4 w-4"}),"Add User"]})]}),e.jsxs(O,{children:[e.jsx(z,{children:e.jsxs(j,{children:[e.jsx(o,{children:"Email"}),e.jsx(o,{children:"Role"}),e.jsx(o,{children:"Added"}),e.jsx(o,{className:"w-20"})]})}),e.jsx(B,{children:ce?e.jsx(j,{children:e.jsx(c,{colSpan:4,className:"text-center text-muted-foreground",children:"Loading..."})}):X.length===0?e.jsx(j,{children:e.jsx(c,{colSpan:4,className:"text-center text-muted-foreground",children:"No users configured"})}):X.map(s=>e.jsxs(j,{children:[e.jsx(c,{children:s.email}),e.jsx(c,{children:s.isAdmin?e.jsx($,{children:"Admin"}):e.jsx($,{variant:"secondary",children:"Viewer"})}),e.jsx(c,{children:new Date(s.addedAt).toLocaleDateString()}),e.jsx(c,{children:e.jsx(x,{variant:"ghost",size:"icon",onClick:()=>K.mutate(s.email),disabled:K.isPending,children:e.jsx(Re,{className:"h-4 w-4 text-destructive"})})})]},s.email))})]})]})]})]})}export{ts as AdminPage};
