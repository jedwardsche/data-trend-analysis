import{j as e,u as ie,b as oe,c as v}from"./query-PEscxNU0.js";import{r as b,k as de}from"./vendor-rrO37E5y.js";import{C as A,a as F,b as P,c as T,d as E}from"./card-7_6ANI-v.js";import{P as J,c as h,a as W,B as m,t as c}from"./index-B29s0vHm.js";import{I as L}from"./input-CxlqfNE9.js";import{B as R}from"./badge-Cig-DYPI.js";import{T as q,a as H,b as f,c as l,d as B,e as d}from"./table-mcyjaVdY.js";import{u as ce,r as le,a as ue,t as me,j as he,k as xe,l as pe,m as z}from"./useDashboardData-Cd9e7vjo.js";import"./firebase-Cbh-IGzk.js";import"./charts-DxkWeNkm.js";var je="Label",Z=b.forwardRef((t,i)=>e.jsx(J.label,{...t,ref:i,onMouseDown:n=>{n.target.closest("button, input, select, textarea")||(t.onMouseDown?.(n),!n.defaultPrevented&&n.detail>1&&n.preventDefault())}}));Z.displayName=je;var ge=Z,ye="Separator",Q="horizontal",ve=["horizontal","vertical"],ee=b.forwardRef((t,i)=>{const{decorative:n,orientation:u=Q,...k}=t,j=fe(u)?u:Q,N=n?{role:"none"}:{"aria-orientation":j==="vertical"?j:void 0,role:"separator"};return e.jsx(J.div,{"data-orientation":j,...N,...k,ref:i})});ee.displayName=ye;function fe(t){return ve.includes(t)}var be=ee;const Ne=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m9 12 2 2 4-4",key:"dzmm74"}]],Se=h("circle-check",Ne);const ke=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m15 9-6 6",key:"1uzhvr"}],["path",{d:"m9 9 6 6",key:"z0biqf"}]],we=h("circle-x",ke);const Ce=[["path",{d:"M12 15V3",key:"m9g1x1"}],["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["path",{d:"m7 10 5 5 5-5",key:"brsn70"}]],K=h("download",Ce);const Me=[["path",{d:"M6 22a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h8a2.4 2.4 0 0 1 1.704.706l3.588 3.588A2.4 2.4 0 0 1 20 8v12a2 2 0 0 1-2 2z",key:"1oefj6"}],["path",{d:"M14 2v5a1 1 0 0 0 1 1h5",key:"wfsgrz"}],["path",{d:"M10 9H8",key:"b1mrlr"}],["path",{d:"M16 13H8",key:"t4e002"}],["path",{d:"M16 17H8",key:"z1uh3a"}]],Ae=h("file-text",Me);const Fe=[["path",{d:"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8",key:"v9h5vc"}],["path",{d:"M21 3v5h-5",key:"1q7to0"}],["path",{d:"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16",key:"3uifl3"}],["path",{d:"M8 16H3v5",key:"1cv678"}]],X=h("refresh-cw",Fe);const Pe=[["path",{d:"M10 11v6",key:"nco0om"}],["path",{d:"M14 11v6",key:"outv1u"}],["path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6",key:"miytrc"}],["path",{d:"M3 6h18",key:"d0wm0j"}],["path",{d:"M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2",key:"e791ji"}]],Te=h("trash-2",Pe);const Ee=[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["line",{x1:"19",x2:"19",y1:"8",y2:"14",key:"1bvyxn"}],["line",{x1:"22",x2:"16",y1:"11",y2:"11",key:"1shjgl"}]],Ue=h("user-plus",Ee);const $e=[["path",{d:"M18 6 6 18",key:"1bl5f8"}],["path",{d:"m6 6 12 12",key:"d8bk6v"}]],De=h("x",$e);function G({className:t,...i}){return e.jsx(ge,{"data-slot":"label",className:W("flex items-center gap-2 text-sm leading-none font-medium select-none group-data-[disabled=true]:pointer-events-none group-data-[disabled=true]:opacity-50 peer-disabled:cursor-not-allowed peer-disabled:opacity-50",t),...i})}function _e({className:t,orientation:i="horizontal",decorative:n=!0,...u}){return e.jsx(be,{"data-slot":"separator",decorative:n,orientation:i,className:W("bg-border shrink-0 data-[orientation=horizontal]:h-px data-[orientation=horizontal]:w-full data-[orientation=vertical]:h-full data-[orientation=vertical]:w-px",t),...u})}function Qe(){const{selectedYear:t}=de(),i=ie(),[n,u]=b.useState(""),[k,j]=b.useState(!1),[U,N]=b.useState({}),[w,C]=b.useState(null),{data:se}=ce(t),S=se?.settings,{data:te,isLoading:ne}=oe({queryKey:["allowedUsers"],queryFn:()=>z({action:"list"})}),x=v({mutationFn:me,onMutate:()=>{C(null)},onSuccess:s=>{const a=s.details?.errors?.length||0,r=s.details?.processed||0,o=a>0?`Sync completed: ${r} records processed with ${a} error(s)`:`Sync completed successfully: ${r} records processed`;C({type:a>0?"error":"success",message:o}),i.invalidateQueries({queryKey:["dashboard"]}),i.invalidateQueries({queryKey:["snapshot"]})},onError:s=>{C({type:"error",message:"Sync failed: "+s.message})}}),I=v({mutationFn:he,onSuccess:()=>{c.success("Settings updated")},onError:s=>{c.error("Failed to update settings: "+s.message)}}),O=v({mutationFn:s=>z({action:"add",...s}),onSuccess:()=>{c.success("User added"),u(""),j(!1),i.invalidateQueries({queryKey:["allowedUsers"]})},onError:s=>{c.error("Failed to add user: "+s.message)}}),V=v({mutationFn:s=>z({action:"remove",email:s}),onSuccess:()=>{c.success("User removed"),i.invalidateQueries({queryKey:["allowedUsers"]})},onError:s=>{c.error("Failed to remove user: "+s.message)}}),$=v({mutationFn:()=>xe({schoolYear:t,reportType:"annual"}),onSuccess:s=>{window.open(s.url,"_blank"),c.success("PDF generated")},onError:s=>{c.error("PDF export failed: "+s.message)}}),M=v({mutationFn:s=>pe({schoolYear:t,dataType:s}),onSuccess:(s,a)=>{const r=new Blob([s.csv],{type:"text/csv"}),o=URL.createObjectURL(r),g=document.createElement("a");g.href=o,g.download=`${t}-${a}.csv`,g.click(),URL.revokeObjectURL(o),c.success("CSV downloaded")},onError:s=>{c.error("CSV export failed: "+s.message)}}),ae=s=>{s.preventDefault(),n&&O.mutate({email:n,isAdmin:k})},re=s=>{const a=U[s];if(!a)return;const r=parseInt(a.students,10),o=parseFloat(a.perStudentCost);if(isNaN(r)||r<0||isNaN(o)||o<0)return;const y={...S?.fundingByYear||{},[s]:{students:r,perStudentCost:o}};I.mutate({fundingByYear:y}),N(D=>({...D,[s]:{students:"",perStudentCost:""}}))},Y=te?.users||[];return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold",children:"Admin"}),e.jsx("p",{className:"text-muted-foreground",children:"Manage sync, settings, and users"})]}),e.jsxs(A,{children:[e.jsxs(F,{children:[e.jsx(P,{children:"Data Sync"}),e.jsx(T,{children:"Manually trigger a sync from Airtable to refresh all metrics"})]}),e.jsxs(E,{className:"space-y-4",children:[e.jsxs("div",{className:"flex gap-4",children:[e.jsxs(m,{onClick:()=>x.mutate({}),disabled:x.isPending,children:[e.jsx(X,{className:`mr-2 h-4 w-4 ${x.isPending?"animate-spin":""}`}),x.isPending?"Syncing...":"Sync All Years"]}),e.jsxs(m,{variant:"outline",onClick:()=>x.mutate({schoolYear:t}),disabled:x.isPending,children:["Sync ",t," Only"]})]}),x.isPending&&e.jsxs("div",{className:"flex items-center gap-2 rounded-md border border-border bg-muted/50 p-3",children:[e.jsx(X,{className:"h-4 w-4 animate-spin text-muted-foreground"}),e.jsx("p",{className:"text-sm font-medium",children:"Syncing data from Airtable... This may take a few minutes."})]}),w&&e.jsxs("div",{className:`flex items-start justify-between gap-2 rounded-md border p-3 ${w.type==="success"?"border-success/30 bg-success/10 text-success":"border-destructive/30 bg-destructive/10 text-destructive"}`,children:[e.jsxs("div",{className:"flex items-start gap-2",children:[w.type==="success"?e.jsx(Se,{className:"h-5 w-5 mt-0.5 shrink-0"}):e.jsx(we,{className:"h-5 w-5 mt-0.5 shrink-0"}),e.jsx("p",{className:"text-sm font-medium",children:w.message})]}),e.jsx("button",{onClick:()=>C(null),className:"shrink-0 rounded-sm opacity-70 hover:opacity-100",children:e.jsx(De,{className:"h-4 w-4"})})]})]})]}),e.jsxs(A,{children:[e.jsxs(F,{children:[e.jsx(P,{children:"Funding Settings"}),e.jsx(T,{children:"Enter the number of students and per-student cost for each year. Total funding is calculated automatically."})]}),e.jsx(E,{children:S&&e.jsx("div",{className:"space-y-4",children:e.jsxs(q,{children:[e.jsx(H,{children:e.jsxs(f,{children:[e.jsx(l,{className:"w-28",children:"Year"}),e.jsx(l,{children:"Students"}),e.jsx(l,{children:"Per-Student Cost"}),e.jsx(l,{className:"text-right",children:"Total Funding"}),e.jsx(l,{className:"w-16"})]})}),e.jsx(B,{children:S.activeSchoolYears.map(s=>{const a=S.fundingByYear?.[s],r=a!=null&&typeof a=="object"?a:null,o=le(a),g=s===S.currentSchoolYear,y=U[s],D=y?.students||y?.perStudentCost;return e.jsxs(f,{children:[e.jsxs(d,{className:"font-medium",children:[s,g&&e.jsx(R,{variant:"outline",className:"ml-1 text-[10px] py-0",children:"Current"})]}),e.jsx(d,{children:e.jsx(L,{type:"number",placeholder:r?String(r.students):"# students",value:y?.students||"",onChange:_=>N(p=>({...p,[s]:{...p[s],students:_.target.value,perStudentCost:p[s]?.perStudentCost||""}})),className:"w-28"})}),e.jsx(d,{children:e.jsx(L,{type:"number",placeholder:r?String(r.perStudentCost):"$ per student",value:y?.perStudentCost||"",onChange:_=>N(p=>({...p,[s]:{...p[s],perStudentCost:_.target.value,students:p[s]?.students||""}})),className:"w-32"})}),e.jsx(d,{className:"text-right font-semibold text-success",children:o!=null?ue(o):"â€”"}),e.jsx(d,{children:e.jsx(m,{size:"sm",onClick:()=>re(s),disabled:I.isPending||!D,children:"Save"})})]},s)})})]})})})]}),e.jsxs(A,{children:[e.jsxs(F,{children:[e.jsx(P,{children:"Exports"}),e.jsxs(T,{children:["Download reports and data for ",t]})]}),e.jsx(E,{children:e.jsxs("div",{className:"flex flex-wrap gap-4",children:[e.jsxs(m,{variant:"outline",onClick:()=>$.mutate(),disabled:$.isPending,children:[e.jsx(Ae,{className:"mr-2 h-4 w-4"}),$.isPending?"Generating...":"Annual Report (PDF)"]}),e.jsxs(m,{variant:"outline",onClick:()=>M.mutate("enrollment"),disabled:M.isPending,children:[e.jsx(K,{className:"mr-2 h-4 w-4"}),"Enrollment (CSV)"]}),e.jsxs(m,{variant:"outline",onClick:()=>M.mutate("timeline"),disabled:M.isPending,children:[e.jsx(K,{className:"mr-2 h-4 w-4"}),"Timeline (CSV)"]})]})})]}),e.jsx(_e,{}),e.jsxs(A,{children:[e.jsxs(F,{children:[e.jsx(P,{children:"Allowed Users"}),e.jsx(T,{children:"Manage who can access the dashboard"})]}),e.jsxs(E,{className:"space-y-6",children:[e.jsxs("form",{onSubmit:ae,className:"flex gap-4 items-end",children:[e.jsxs("div",{className:"space-y-2 flex-1",children:[e.jsx(G,{htmlFor:"email",children:"Email Address"}),e.jsx(L,{id:"email",type:"email",placeholder:"user@che.school",value:n,onChange:s=>u(s.target.value)})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",id:"isAdmin",checked:k,onChange:s=>j(s.target.checked)}),e.jsx(G,{htmlFor:"isAdmin",children:"Admin"})]}),e.jsxs(m,{type:"submit",disabled:O.isPending||!n,children:[e.jsx(Ue,{className:"mr-2 h-4 w-4"}),"Add User"]})]}),e.jsxs(q,{children:[e.jsx(H,{children:e.jsxs(f,{children:[e.jsx(l,{children:"Email"}),e.jsx(l,{children:"Role"}),e.jsx(l,{children:"Added"}),e.jsx(l,{className:"w-20"})]})}),e.jsx(B,{children:ne?e.jsx(f,{children:e.jsx(d,{colSpan:4,className:"text-center text-muted-foreground",children:"Loading..."})}):Y.length===0?e.jsx(f,{children:e.jsx(d,{colSpan:4,className:"text-center text-muted-foreground",children:"No users configured"})}):Y.map(s=>e.jsxs(f,{children:[e.jsx(d,{children:s.email}),e.jsx(d,{children:s.isAdmin?e.jsx(R,{children:"Admin"}):e.jsx(R,{variant:"secondary",children:"Viewer"})}),e.jsx(d,{children:new Date(s.addedAt).toLocaleDateString()}),e.jsx(d,{children:e.jsx(m,{variant:"ghost",size:"icon",onClick:()=>V.mutate(s.email),disabled:V.isPending,children:e.jsx(Te,{className:"h-4 w-4 text-destructive"})})})]},s.email))})]})]})]})]})}export{Qe as AdminPage};
