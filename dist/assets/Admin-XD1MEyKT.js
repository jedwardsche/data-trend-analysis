import{j as e,b as oe,u as ce,c as b}from"./query-DCZjxv-P.js";import{r as w,k as de,N as le}from"./vendor-rrO37E5y.js";import{C as U,a as P,b as E,c as T,d as L}from"./card-DwHXhc3O.js";import{P as W,c as j,a as Z,b as ue,B as p,t as me,r as he,s as d,v as xe,w as pe,x as _}from"./index-CykV7N1A.js";import{I as O}from"./input-BbaI2hjk.js";import{B as z}from"./badge-C6bK7CU_.js";import{T as Y,a as H,b as N,c as m,d as Q,e as o}from"./table-BZZOL2yI.js";import{r as je,a as ge}from"./formatters-Lk1sxCTq.js";import"./firebase-Cbh-IGzk.js";import"./charts-DxkWeNkm.js";var ye="Label",ee=w.forwardRef((t,l)=>e.jsx(W.label,{...t,ref:l,onMouseDown:r=>{r.target.closest("button, input, select, textarea")||(t.onMouseDown?.(r),!r.defaultPrevented&&r.detail>1&&r.preventDefault())}}));ee.displayName=ye;var fe=ee,ve="Separator",K="horizontal",be=["horizontal","vertical"],se=w.forwardRef((t,l)=>{const{decorative:r,orientation:c=K,...k}=t,v=Ne(c)?c:K,C=r?{role:"none"}:{"aria-orientation":v==="vertical"?v:void 0,role:"separator"};return e.jsx(W.div,{"data-orientation":v,...C,...k,ref:l})});se.displayName=ve;function Ne(t){return be.includes(t)}var we=se;const Se=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m9 12 2 2 4-4",key:"dzmm74"}]],ke=j("circle-check",Se);const Ce=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m15 9-6 6",key:"1uzhvr"}],["path",{d:"m9 9 6 6",key:"z0biqf"}]],Me=j("circle-x",Ce);const Ae=[["path",{d:"M12 15V3",key:"m9g1x1"}],["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["path",{d:"m7 10 5 5 5-5",key:"brsn70"}]],X=j("download",Ae);const Fe=[["path",{d:"M6 22a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h8a2.4 2.4 0 0 1 1.704.706l3.588 3.588A2.4 2.4 0 0 1 20 8v12a2 2 0 0 1-2 2z",key:"1oefj6"}],["path",{d:"M14 2v5a1 1 0 0 0 1 1h5",key:"wfsgrz"}],["path",{d:"M10 9H8",key:"b1mrlr"}],["path",{d:"M16 13H8",key:"t4e002"}],["path",{d:"M16 17H8",key:"z1uh3a"}]],Ue=j("file-text",Fe);const Pe=[["path",{d:"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8",key:"v9h5vc"}],["path",{d:"M21 3v5h-5",key:"1q7to0"}],["path",{d:"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16",key:"3uifl3"}],["path",{d:"M8 16H3v5",key:"1cv678"}]],G=j("refresh-cw",Pe);const Ee=[["path",{d:"M10 11v6",key:"nco0om"}],["path",{d:"M14 11v6",key:"outv1u"}],["path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6",key:"miytrc"}],["path",{d:"M3 6h18",key:"d0wm0j"}],["path",{d:"M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2",key:"e791ji"}]],Te=j("trash-2",Ee);const Le=[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["line",{x1:"19",x2:"19",y1:"8",y2:"14",key:"1bvyxn"}],["line",{x1:"22",x2:"16",y1:"11",y2:"11",key:"1shjgl"}]],Re=j("user-plus",Le);const $e=[["path",{d:"M18 6 6 18",key:"1bl5f8"}],["path",{d:"m6 6 12 12",key:"d8bk6v"}]],De=j("x",$e);function J({className:t,...l}){return e.jsx(fe,{"data-slot":"label",className:Z("flex items-center gap-2 text-sm leading-none font-medium select-none group-data-[disabled=true]:pointer-events-none group-data-[disabled=true]:opacity-50 peer-disabled:cursor-not-allowed peer-disabled:opacity-50",t),...l})}function _e({className:t,orientation:l="horizontal",decorative:r=!0,...c}){return e.jsx(we,{"data-slot":"separator",decorative:r,orientation:l,className:Z("bg-border shrink-0 data-[orientation=horizontal]:h-px data-[orientation=horizontal]:w-full data-[orientation=vertical]:h-full data-[orientation=vertical]:w-px",t),...c})}function Xe(){const{selectedYear:t,isAdmin:l}=de();if(!l)return e.jsx(le,{to:"/dashboard",replace:!0});const r=oe(),[c,k]=w.useState(""),[v,R]=w.useState(!1),[C,$]=w.useState({}),[M,A]=w.useState(null),{data:te}=ue(t),S=te?.settings,{data:ae,isLoading:ne}=ce({queryKey:["allowedUsers"],queryFn:()=>_({action:"list"})}),g=b({mutationFn:me,onMutate:()=>{A(null)},onSuccess:s=>{const a=s.details?.errors?.length||0,n=s.details?.processed||0,i=a>0?`Sync completed: ${n} records processed with ${a} error(s)`:`Sync completed successfully: ${n} records processed`;A({type:a>0?"error":"success",message:i}),r.invalidateQueries({queryKey:["dashboard"]}),r.invalidateQueries({queryKey:["snapshot"]})},onError:s=>{A({type:"error",message:"Sync failed: "+s.message})}}),I=b({mutationFn:he,onSuccess:()=>{d.success("Settings updated"),r.invalidateQueries({queryKey:["dashboard"]})},onError:s=>{d.error("Failed to update settings: "+s.message)}}),q=b({mutationFn:s=>_({action:"add",...s}),onSuccess:()=>{d.success("User added"),k(""),R(!1),r.invalidateQueries({queryKey:["allowedUsers"]})},onError:s=>{d.error("Failed to add user: "+s.message)}}),B=b({mutationFn:s=>_({action:"remove",email:s}),onSuccess:()=>{d.success("User removed"),r.invalidateQueries({queryKey:["allowedUsers"]})},onError:s=>{d.error("Failed to remove user: "+s.message)}}),D=b({mutationFn:()=>xe({schoolYear:t,reportType:"annual"}),onSuccess:s=>{const a=atob(s.pdfBase64),n=new Array(a.length);for(let x=0;x<a.length;x++)n[x]=a.charCodeAt(x);const i=new Uint8Array(n),h=new Blob([i],{type:"application/pdf"}),u=URL.createObjectURL(h),y=document.createElement("a");y.href=u,y.download=s.fileName,y.click(),URL.revokeObjectURL(u),d.success("PDF downloaded")},onError:s=>{d.error("PDF export failed: "+s.message)}}),F=b({mutationFn:s=>pe({schoolYear:t,dataType:s}),onSuccess:(s,a)=>{const n=new Blob([s.csv],{type:"text/csv"}),i=URL.createObjectURL(n),h=document.createElement("a");h.href=i,h.download=`${t}-${a}.csv`,h.click(),URL.revokeObjectURL(i),d.success("CSV downloaded")},onError:s=>{d.error("CSV export failed: "+s.message)}}),re=s=>{s.preventDefault(),c&&q.mutate({email:c,isAdmin:v})},ie=s=>{const a=C[s];if(!a)return;const n=parseInt(a.students,10),i=parseFloat(a.perStudentCost);if(isNaN(n)||n<0||isNaN(i)||i<0)return;const u={...S?.fundingByYear||{},[s]:{students:n,perStudentCost:i}};I.mutate({fundingByYear:u}),$(y=>({...y,[s]:{students:"",perStudentCost:""}}))},V=ae?.users||[];return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold",children:"Admin"}),e.jsx("p",{className:"text-muted-foreground",children:"Manage sync, settings, and users"})]}),e.jsxs(U,{children:[e.jsxs(P,{children:[e.jsx(E,{children:"Data Sync"}),e.jsx(T,{children:"Manually trigger a sync from Airtable to refresh all metrics"})]}),e.jsxs(L,{className:"space-y-4",children:[e.jsxs("div",{className:"flex gap-4",children:[e.jsxs(p,{onClick:()=>g.mutate({}),disabled:g.isPending,children:[e.jsx(G,{className:`mr-2 h-4 w-4 ${g.isPending?"animate-spin":""}`}),g.isPending?"Syncing...":"Sync All Years"]}),e.jsxs(p,{variant:"outline",onClick:()=>g.mutate({schoolYear:t}),disabled:g.isPending,children:["Sync ",t," Only"]})]}),g.isPending&&e.jsxs("div",{className:"flex items-center gap-2 rounded-md border border-border bg-muted/50 p-3",children:[e.jsx(G,{className:"h-4 w-4 animate-spin text-muted-foreground"}),e.jsx("p",{className:"text-sm font-medium",children:"Syncing data from Airtable... This may take a few minutes."})]}),M&&e.jsxs("div",{className:`flex items-start justify-between gap-2 rounded-md border p-3 ${M.type==="success"?"border-success/30 bg-success/10 text-success":"border-destructive/30 bg-destructive/10 text-destructive"}`,children:[e.jsxs("div",{className:"flex items-start gap-2",children:[M.type==="success"?e.jsx(ke,{className:"h-5 w-5 mt-0.5 shrink-0"}):e.jsx(Me,{className:"h-5 w-5 mt-0.5 shrink-0"}),e.jsx("p",{className:"text-sm font-medium",children:M.message})]}),e.jsx("button",{onClick:()=>A(null),className:"shrink-0 rounded-sm opacity-70 hover:opacity-100",children:e.jsx(De,{className:"h-4 w-4"})})]})]})]}),e.jsxs(U,{children:[e.jsxs(P,{children:[e.jsx(E,{children:"Funding Settings"}),e.jsx(T,{children:"Enter the number of students and per-student cost for each year. Total funding is calculated automatically."})]}),e.jsx(L,{children:S&&e.jsx("div",{className:"space-y-4",children:e.jsxs(Y,{children:[e.jsx(H,{children:e.jsxs(N,{children:[e.jsx(m,{className:"w-28",children:"Year"}),e.jsx(m,{children:"Students"}),e.jsx(m,{children:"Per-Student Cost"}),e.jsx(m,{className:"text-right",children:"Total Funding"}),e.jsx(m,{className:"w-16"})]})}),e.jsx(Q,{children:S.activeSchoolYears.map(s=>{const a=S.fundingByYear?.[s],n=a!=null&&typeof a=="object"?a:null,i=je(a),h=s===S.currentSchoolYear,u=C[s],y=u?.students||u?.perStudentCost;return e.jsxs(N,{children:[e.jsxs(o,{className:"font-medium",children:[s,h&&e.jsx(z,{variant:"outline",className:"ml-1 text-[10px] py-0",children:"Current"})]}),e.jsx(o,{children:e.jsx(O,{type:"number",placeholder:n?String(n.students):"# students",value:u?.students||"",onChange:x=>$(f=>({...f,[s]:{...f[s],students:x.target.value,perStudentCost:f[s]?.perStudentCost||""}})),className:"w-28"})}),e.jsx(o,{children:e.jsx(O,{type:"number",placeholder:n?String(n.perStudentCost):"$ per student",value:u?.perStudentCost||"",onChange:x=>$(f=>({...f,[s]:{...f[s],perStudentCost:x.target.value,students:f[s]?.students||""}})),className:"w-32"})}),e.jsx(o,{className:"text-right font-semibold text-success",children:i!=null?ge(i):"â€”"}),e.jsx(o,{children:e.jsx(p,{size:"sm",onClick:()=>ie(s),disabled:I.isPending||!y,children:"Save"})})]},s)})})]})})})]}),e.jsxs(U,{children:[e.jsxs(P,{children:[e.jsx(E,{children:"Exports"}),e.jsxs(T,{children:["Download reports and data for ",t]})]}),e.jsx(L,{children:e.jsxs("div",{className:"flex flex-wrap gap-4",children:[e.jsxs(p,{variant:"outline",onClick:()=>D.mutate(),disabled:D.isPending,children:[e.jsx(Ue,{className:"mr-2 h-4 w-4"}),D.isPending?"Generating...":"Annual Report (PDF)"]}),e.jsxs(p,{variant:"outline",onClick:()=>F.mutate("enrollment"),disabled:F.isPending,children:[e.jsx(X,{className:"mr-2 h-4 w-4"}),"Enrollment (CSV)"]}),e.jsxs(p,{variant:"outline",onClick:()=>F.mutate("timeline"),disabled:F.isPending,children:[e.jsx(X,{className:"mr-2 h-4 w-4"}),"Timeline (CSV)"]})]})})]}),e.jsx(_e,{}),e.jsxs(U,{children:[e.jsxs(P,{children:[e.jsx(E,{children:"Allowed Users"}),e.jsx(T,{children:"Manage who can access the dashboard"})]}),e.jsxs(L,{className:"space-y-6",children:[e.jsxs("form",{onSubmit:re,className:"flex gap-4 items-end",children:[e.jsxs("div",{className:"space-y-2 flex-1",children:[e.jsx(J,{htmlFor:"email",children:"Email Address"}),e.jsx(O,{id:"email",type:"email",placeholder:"user@che.school",value:c,onChange:s=>k(s.target.value)})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",id:"isAdmin",checked:v,onChange:s=>R(s.target.checked)}),e.jsx(J,{htmlFor:"isAdmin",children:"Admin"})]}),e.jsxs(p,{type:"submit",disabled:q.isPending||!c,children:[e.jsx(Re,{className:"mr-2 h-4 w-4"}),"Add User"]})]}),e.jsxs(Y,{children:[e.jsx(H,{children:e.jsxs(N,{children:[e.jsx(m,{children:"Email"}),e.jsx(m,{children:"Role"}),e.jsx(m,{children:"Added"}),e.jsx(m,{className:"w-20"})]})}),e.jsx(Q,{children:ne?e.jsx(N,{children:e.jsx(o,{colSpan:4,className:"text-center text-muted-foreground",children:"Loading..."})}):V.length===0?e.jsx(N,{children:e.jsx(o,{colSpan:4,className:"text-center text-muted-foreground",children:"No users configured"})}):V.map(s=>e.jsxs(N,{children:[e.jsx(o,{children:s.email}),e.jsx(o,{children:s.isAdmin?e.jsx(z,{children:"Admin"}):e.jsx(z,{variant:"secondary",children:"Viewer"})}),e.jsx(o,{children:new Date(s.addedAt).toLocaleDateString()}),e.jsx(o,{children:e.jsx(p,{variant:"ghost",size:"icon",onClick:()=>B.mutate(s.email),disabled:B.isPending,children:e.jsx(Te,{className:"h-4 w-4 text-destructive"})})})]},s.email))})]})]})]})]})}export{Xe as AdminPage};
